\begin{tikzpicture}[node distance=10mm]

\def\mainkernelleftcornerx{-2mm}

\draw[fill=col6!25] (-6.5mm, 4mm) rectangle (12mm, -28mm);
\draw[fill=col13!8] (12mm, 4mm) rectangle (50mm, -28mm);

\draw[fill=col1!20] (-2mm, 3mm) rectangle (10mm, -25mm);
\draw[fill=col2!20,draw=none] (-1mm,0mm) rectangle (9mm, -24mm);
\draw[fill=col1!20] (14mm, 3mm) rectangle (18mm, -25mm);
\draw[fill=col2!20,draw=none] (15mm,0mm) rectangle (17mm, -24mm);
\node[scale=0.6,anchor=south east] at (9.5mm, -28mm) {main kernel};

\node[scale=0.6,anchor=south] at (0mm, 0mm) {m};
\draw[thread] (0mm, 0mm) -- (0mm, -8mm);
\foreach \c [evaluate=\c as \tid using int(\c/2-1)] in {2, 4, 6, 8} {
\node[scale=0.6,anchor=south] (n) at (\c mm, 0mm) {\tid};
\draw[workerthread] (n.south) -- (\c mm, -8mm);
}

\draw[thick, dotted] (-2mm, -8mm) -- (10mm, -8mm);
\draw[thick, dotted] (14mm, -8mm) -- (18mm, -8mm);

\node[scale=0.6,anchor=east] at (-2mm, -8mm) {fork};

\draw[workerthread] (0mm, -8mm) -- (0mm, -16mm);
\foreach \c in {2, 4, 6, 8} {
\draw[thread] (\c mm, -8mm) -- (\c mm, -16mm);
}

\draw[thick, dotted] (-2mm, -16mm) -- (10mm, -16mm);
\draw[thick, dotted] (14mm, -16mm) -- (18mm, -16mm);

\node[scale=0.6,anchor=east] at (-2mm, -16mm) {join};

\draw[thread] (0mm, -16mm) -- (0mm, -24mm);
\foreach \c in {2, 4, 6, 8} {
\draw[workerthread] (\c mm, -16mm) -- (\c mm, -24mm);
}

% \draw[thick] (12mm, 3mm) -- (12mm, -28mm);

\node[scale=0.6,anchor=south] at (16mm, 0mm) {m};
\draw[thread] (16mm, 0mm) -- (16mm, -8mm);
\draw[workerthread] (16mm, -8mm) -- (16mm, -16mm);
\draw[thread] (16mm, -16mm) -- (16mm, -24mm);

\node[scale=0.6,anchor=south west] at (12mm, -28mm) {main kernel};

\node[] (host) at (24mm, -11.5mm) {\huge\faIcon[regular]{hourglass}};
\node[scale=0.7] at (host.south) {host};

\draw[->] ($(16mm, -8mm) + (2mm, 0mm)$) -- node [above,scale=0.6] {\textcircled{\raisebox{-.7pt}{1}}} ($(host.north west) + (0.5mm, -1mm)$);
\draw[->] ($(host.south west) + (0.5mm, 1mm)$) -- node [below,scale=0.6,pos=0.2] {\textcircled{\raisebox{-.7pt}{3}}} ($(16mm, -16mm) + (2mm, 0mm)$);

\draw[<->] (host.east) -- node [above,scale=0.6] {\textcircled{\raisebox{-.7pt}{2}}} ($(host.east) + (3mm, 0mm)$);

\draw[fill=col4!20] (30mm,1mm) rectangle (49mm, -24mm);
\node[scale=0.6,anchor=south] at (40mm, -28mm) {parallel kernel};

\draw[fill=col2!20,draw=none] (31mm, -2mm) rectangle (39mm, -10mm);
\foreach \c [evaluate=\c as \tid using int(\c/2)] in {0, 2, 4, 6} {
\node[scale=0.6,anchor=south] (n) at ($(32 mm, -2mm) + (\c mm, 0mm)$) {\tid};
\draw[thread] (n.south) -- ($(32 mm, -10mm) + (\c mm, 0mm)$);
}

\draw[fill=col2!20,draw=none] (40mm, -2mm) rectangle (48mm, -10mm);
\foreach \c [evaluate=\c as \tid using int(\c/2 + 4)] in {0, 2, 4, 6} {
\node[scale=0.6,anchor=south] (n) at ($(41 mm, -2mm) + (\c mm, 0mm)$) {\tid};
\draw[thread] (n.south) -- ($(41 mm, -10mm) + (\c mm, 0mm)$);
}

\draw[fill=col2!20,draw=none] (31mm, -13mm) rectangle (39mm, -21mm);
\foreach \c [evaluate=\c as \tid using int(\c/2+8)] in {0, 2, 4, 6} {
\node[scale=0.6,anchor=north] (n) at ($(32 mm, -21mm) + (\c mm, 0mm)$) {\tid};
\draw[thread] ($(32 mm, -13mm) + (\c mm, 0mm)$) -- (n.north);
}

\draw[fill=col2!20,draw=none] (40mm, -13mm) rectangle (48mm, -21mm);
\foreach \c [evaluate=\c as \tid using int(\c/2+12)] in {0, 2, 4, 6} {
\node[scale=0.6,anchor=north] (n) at ($(41mm, -21mm) + (\c mm, 0mm)$) {\tid};
\draw[thread] ($(41mm, -13mm) + (\c mm, 0mm)$) -- (n.north);
}

\end{tikzpicture}
